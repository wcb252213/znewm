<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½äºŒç»´ç åˆå¹¶å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 40px;
            align-items: start;
        }

        .left-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 20px;
        }

        .right-panel {
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #1a1a1a;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .description {
            background: linear-gradient(135deg, #e8f4ff 0%, #f3e7ff 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 14px;
            border-left: 4px solid #667eea;
        }

        .description h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-section {
            margin-bottom: 20px;
        }

        .upload-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .upload-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 0;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .upload-box:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .upload-box.active {
            border-color: #667eea;
            background-color: #e8f4ff;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-box img {
            max-width: 200px;
            max-height: 200px;
            margin: 10px auto;
            display: block;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .control-group label {
            min-width: 120px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .control-group input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .control-group span {
            min-width: 60px;
            text-align: right;
            color: #667eea;
            font-weight: bold;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-area {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .result-area h3 {
            margin-bottom: 20px;
            color: #333;
        }

        #canvas {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            width: auto;
            height: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border-left: 4px solid #28a745;
        }

        input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: bold;
        }

        input[type="radio"]:checked {
            accent-color: #667eea;
        }

        label:has(input[type="radio"]:checked) {
            border-color: #667eea !important;
            background-color: #e8f4ff !important;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .left-panel {
                max-height: none;
            }

            .right-panel {
                position: relative;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .upload-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ æ™ºèƒ½äºŒç»´ç åˆå¹¶å·¥å…·</h1>
        <p class="subtitle">è‡ªåŠ¨è¯†åˆ«å¹¶é‡æ–°ç”Ÿæˆ,å®Œç¾åˆå¹¶å¾®ä¿¡å’Œæ”¯ä»˜å®æ”¶æ¬¾ç </p>

        <div class="success-message" id="successMessage"></div>

        <div class="main-layout">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panel">

                <div class="upload-section">
            <h3>ğŸ“¤ ä¸Šä¼ äºŒç»´ç </h3>
            <div class="upload-area">
                <div class="upload-box" onclick="document.getElementById('wechatFile').click()">
                    <input type="file" id="wechatFile" accept="image/*">
                    <div>ğŸ’š ä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç </div>
                    <div id="wechatStatus" style="color: #666; font-size: 14px; margin-top: 10px;">ç‚¹å‡»ä¸Šä¼ </div>
                </div>
                <div class="upload-box" onclick="document.getElementById('alipayFile').click()">
                    <input type="file" id="alipayFile" accept="image/*">
                    <div>ğŸ’™ ä¸Šä¼ æ”¯ä»˜å®æ”¶æ¬¾ç </div>
                    <div id="alipayStatus" style="color: #666; font-size: 14px; margin-top: 10px;">ç‚¹å‡»ä¸Šä¼ </div>
                </div>
            </div>
        </div>

        <div class="control-section">
            <h3>âš™ï¸ å‚æ•°è°ƒæ•´</h3>
            <div class="control-group">
                <label>æ•´ä½“å¤§å°:</label>
                <input type="range" id="overallSize" min="400" max="1200" value="600" oninput="updateValues()">
                <span id="overallSizeValue">600</span>px
            </div>
            <div class="control-group">
                <label>æ”¯ä»˜å®æ¯”ä¾‹:</label>
                <input type="range" id="alipayRatio" min="20" max="50" value="35" oninput="updateValues()">
                <span id="alipayRatioValue">35</span>%
            </div>
            <div class="control-group">
                <label>å³/ä¸‹è¾¹è·:</label>
                <input type="range" id="marginRight" min="0" max="50" value="5" oninput="updateValues()" style="width: 45%; display: inline-block;">
                <span id="marginRightValue">5</span>
                <input type="range" id="marginBottom" min="0" max="50" value="5" oninput="updateValues()" style="width: 45%; display: inline-block; margin-left: 10px;">
                <span id="marginBottomValue">5</span>
            </div>
        </div>

        <div class="control-section">
            <h3>ğŸ¨ è¾¹æ¡†å’Œæ–‡å­—(å¯é€‰)</h3>

            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">ğŸ“· ä¸Šä¼ è¾¹æ¡†(å¯é€‰):</label>
                <div class="upload-box" onclick="document.getElementById('frameFile').click()" style="max-width: 100%;">
                    <input type="file" id="frameFile" accept="image/*" style="display: none;">
                    <div>ğŸ–¼ï¸ ç‚¹å‡»ä¸Šä¼ è¾¹æ¡†</div>
                    <div id="frameStatus" style="color: #666; font-size: 12px; margin-top: 8px;">æœªä¸Šä¼ </div>
                </div>
                <small style="color: #999; display: block; margin-top: 5px; font-size: 12px;">PNGæ ¼å¼,é€æ˜ä¸­å¿ƒåŒºåŸŸ</small>
            </div>

            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">ğŸ“ æ–‡å­—å†…å®¹:</label>
                <input type="text" id="bottomText" placeholder="ä¾‹å¦‚: æ”¯æŒå¾®ä¿¡/æ”¯ä»˜å®æ‰«ç æ”¯ä»˜" oninput="updateValues()" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>

            <div class="control-group">
                <label>æ–‡å­—å¤§å°:</label>
                <input type="range" id="fontSize" min="20" max="80" value="60" oninput="updateValues()">
                <span id="fontSizeValue">60</span>px
            </div>

            <div class="control-group">
                <label>æ–‡å­—é¢œè‰²:</label>
                <input type="color" id="textColor" value="#000000" onchange="updateValues()" style="width: 60px; height: 40px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
            </div>

            <div class="control-group">
                <label>æ–‡å­—ç²—ç»†:</label>
                <select id="fontWeight" onchange="updateValues()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <option value="normal">æ™®é€š</option>
                    <option value="bold" selected>åŠ ç²—</option>
                </select>
            </div>

            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #667eea; font-size: 14px;">ğŸ“ ä½ç½®è°ƒæ•´</h4>

            <div class="control-group">
                <label>äºŒç»´ç Xåæ ‡:</label>
                <input type="range" id="qrPosX" min="-500" max="500" value="0" oninput="updateValues()">
                <span id="qrPosXValue">0</span>px
            </div>

            <div class="control-group">
                <label>äºŒç»´ç Yåæ ‡:</label>
                <input type="range" id="qrPosY" min="-500" max="500" value="-90" oninput="updateValues()">
                <span id="qrPosYValue">-90</span>px
            </div>

            <div class="control-group">
                <label>æ–‡å­—Yåæ ‡:</label>
                <input type="range" id="bottomTextPosY" min="-800" max="500" value="-500" oninput="updateValues()">
                <span id="bottomTextPosYValue">-500</span>px
            </div>
        </div>

        <button onclick="mergeQRCodes()" id="mergeBtn" disabled style="width: 100%; margin-top: 15px;">ğŸ¨ å¼€å§‹åˆå¹¶äºŒç»´ç </button>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <div id="resultArea" class="result-area" style="display: block;">
                    <h3>é¢„è§ˆåŒºåŸŸ</h3>
                    <p style="color: #999; margin-top: 10px;">åˆå¹¶åçš„äºŒç»´ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div style="margin-top: 20px; display: none;" id="downloadBtn">
                        <button onclick="downloadImage()">ğŸ“¥ ä¸‹è½½åˆå¹¶åçš„äºŒç»´ç </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ jsQR åº“ç”¨äºè¯†åˆ«äºŒç»´ç  -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- å¼•å…¥ qrcode-generator åº“ç”¨äºç”ŸæˆäºŒç»´ç  -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <script>
        let wechatImage = null;
        let alipayImage = null;
        let wechatData = null;
        let alipayData = null;
        let frameImage = null;

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é»˜è®¤è¾¹æ¡†
        window.addEventListener('load', function() {
            loadDefaultFrame();
        });

        function loadDefaultFrame() {
            const img = new Image();
            img.onload = function() {
                console.log('é»˜è®¤è¾¹æ¡†åŠ è½½æˆåŠŸ: æ¨¡ç‰ˆ1.png', img.width, 'x', img.height);
                frameImage = img;
                document.getElementById('frameStatus').textContent = 'âœ… æ¨¡ç‰ˆ1.png';
            };
            img.onerror = function() {
                console.log('é»˜è®¤è¾¹æ¡†ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥: æ¨¡ç‰ˆ1.png');
                document.getElementById('frameStatus').textContent = 'æœªä¸Šä¼ ';
            };
            img.src = 'æ¨¡ç‰ˆ1.png';
        }

        function showMessage(message) {
            const msg = document.getElementById('successMessage');
            msg.textContent = message;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function updateValues() {
            document.getElementById('overallSizeValue').textContent = document.getElementById('overallSize').value;
            document.getElementById('alipayRatioValue').textContent = document.getElementById('alipayRatio').value;
            document.getElementById('marginRightValue').textContent = document.getElementById('marginRight').value;
            document.getElementById('marginBottomValue').textContent = document.getElementById('marginBottom').value;
            document.getElementById('fontSizeValue').textContent = document.getElementById('fontSize').value;
            document.getElementById('qrPosXValue').textContent = document.getElementById('qrPosX').value;
            document.getElementById('qrPosYValue').textContent = document.getElementById('qrPosY').value;
            document.getElementById('bottomTextPosYValue').textContent = document.getElementById('bottomTextPosY').value;

            // å¦‚æœå·²ç»ç”Ÿæˆè¿‡,å®æ—¶æ›´æ–°(ä½†ä¸è§¦å‘æ»šåŠ¨)
            if (wechatData && alipayData) {
                mergeQRCodes(true);  // ä¼ é€’å‚æ•°è¡¨ç¤ºæ˜¯å®æ—¶æ›´æ–°
            }
        }

        // å¤„ç†è¾¹æ¡†å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('frameFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                console.log('è¾¹æ¡†: æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            console.log('è¾¹æ¡†: æ–‡ä»¶å·²é€‰æ‹©', file.name, file.type, file.size, 'bytes');
            document.getElementById('frameStatus').textContent = 'æ­£åœ¨åŠ è½½...';

            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('è¾¹æ¡†: æ–‡ä»¶è¯»å–å®Œæˆ');
                const img = new Image();
                img.onload = function() {
                    console.log('è¾¹æ¡†: å›¾ç‰‡åŠ è½½å®Œæˆ', img.width, 'x', img.height);
                    frameImage = img;
                    document.getElementById('frameStatus').textContent = 'âœ… å·²ä¸Šä¼ ';

                    // å¦‚æœå·²ç»ç”Ÿæˆè¿‡äºŒç»´ç ,å®æ—¶æ›´æ–°
                    if (wechatData && alipayData) {
                        mergeQRCodes();
                    }
                };
                img.onerror = function() {
                    console.error('è¾¹æ¡†: å›¾ç‰‡åŠ è½½å¤±è´¥');
                    document.getElementById('frameStatus').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                console.error('è¾¹æ¡†: æ–‡ä»¶è¯»å–å¤±è´¥');
                document.getElementById('frameStatus').textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥';
            };
            reader.readAsDataURL(file);
        });

        // å¤„ç†å¾®ä¿¡äºŒç»´ç ä¸Šä¼ 
        document.getElementById('wechatFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                console.log('å¾®ä¿¡: æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            console.log('å¾®ä¿¡: æ–‡ä»¶å·²é€‰æ‹©', file.name, file.type, file.size, 'bytes');
            document.getElementById('wechatStatus').textContent = 'æ­£åœ¨è¯†åˆ«...';

            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('å¾®ä¿¡: æ–‡ä»¶è¯»å–å®Œæˆ');
                const img = new Image();
                img.onload = function() {
                    console.log('å¾®ä¿¡: å›¾ç‰‡åŠ è½½å®Œæˆ', img.width, 'x', img.height);
                    wechatImage = img;

                    // è¯†åˆ«äºŒç»´ç 
                    decodeQRCode(img, 'wechat');
                };
                img.onerror = function() {
                    console.error('å¾®ä¿¡: å›¾ç‰‡åŠ è½½å¤±è´¥');
                    document.getElementById('wechatStatus').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                console.error('å¾®ä¿¡: æ–‡ä»¶è¯»å–å¤±è´¥');
                document.getElementById('wechatStatus').textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥';
            };
            reader.readAsDataURL(file);
        });

        // å¤„ç†æ”¯ä»˜å®äºŒç»´ç ä¸Šä¼ 
        document.getElementById('alipayFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                console.log('æ”¯ä»˜å®: æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            console.log('æ”¯ä»˜å®: æ–‡ä»¶å·²é€‰æ‹©', file.name, file.type, file.size, 'bytes');
            document.getElementById('alipayStatus').textContent = 'æ­£åœ¨è¯†åˆ«...';

            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('æ”¯ä»˜å®: æ–‡ä»¶è¯»å–å®Œæˆ');
                const img = new Image();
                img.onload = function() {
                    console.log('æ”¯ä»˜å®: å›¾ç‰‡åŠ è½½å®Œæˆ', img.width, 'x', img.height);
                    alipayImage = img;

                    // è¯†åˆ«äºŒç»´ç 
                    decodeQRCode(img, 'alipay');
                };
                img.onerror = function() {
                    console.error('æ”¯ä»˜å®: å›¾ç‰‡åŠ è½½å¤±è´¥');
                    document.getElementById('alipayStatus').textContent = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                console.error('æ”¯ä»˜å®: æ–‡ä»¶è¯»å–å¤±è´¥');
                document.getElementById('alipayStatus').textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥';
            };
            reader.readAsDataURL(file);
        });

        async function decodeQRCodeWithAPI(canvas, type) {
            console.log(`${type}: jsQRå¤±è´¥,å°è¯•ä½¿ç”¨åœ¨çº¿APIè¯†åˆ«`);

            try {
                // è½¬æ¢ä¸ºBlob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                // ä½¿ç”¨FormDataä¸Šä¼ 
                const formData = new FormData();
                formData.append('file', blob, 'qrcode.png');

                console.log(`${type}: è°ƒç”¨api.qrserver.com API`);
                const response = await fetch('https://api.qrserver.com/v1/read-qr-code/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log(`${type}: APIè¿”å›:`, result);

                if (result && result[0] && result[0].symbol && result[0].symbol[0] && result[0].symbol[0].data) {
                    const qrData = result[0].symbol[0].data;
                    console.log(`${type}: âœ… APIè¯†åˆ«æˆåŠŸ!`);
                    console.log(`${type}: äºŒç»´ç å†…å®¹:`, qrData);
                    return qrData;
                }

                console.log(`${type}: APIä¹Ÿæ— æ³•è¯†åˆ«`);
                return null;
            } catch (error) {
                console.error(`${type}: APIè¯†åˆ«å‡ºé”™:`, error);
                return null;
            }
        }

        async function decodeQRCode(image, type) {
            console.log(`${type}: å¼€å§‹è¯†åˆ«äºŒç»´ç `);
            console.log(`${type}: å›¾ç‰‡å°ºå¯¸`, image.width, 'x', image.height);

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;

            console.log(`${type}: ç»˜åˆ¶å›¾ç‰‡åˆ°Canvas`);
            ctx.drawImage(image, 0, 0);

            console.log(`${type}: è·å–å›¾ç‰‡æ•°æ®`);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            console.log(`${type}: å›¾ç‰‡æ•°æ®å¤§å°`, imageData.data.length, 'bytes');

            console.log(`${type}: è°ƒç”¨jsQRè¯†åˆ«`);
            let code = jsQR(imageData.data, imageData.width, imageData.height);

            console.log(`${type}: jsQRè¿”å›ç»“æœ:`, code);

            let qrData = null;

            if (code) {
                console.log(`${type}: âœ… jsQRè¯†åˆ«æˆåŠŸ!`);
                console.log(`${type}: äºŒç»´ç å†…å®¹:`, code.data);
                console.log(`${type}: äºŒç»´ç ä½ç½®:`, code.location);
                qrData = code.data;
            } else {
                console.warn(`${type}: âŒ jsQRè¯†åˆ«å¤±è´¥`);
                console.log(`${type}: å°è¯•ä½¿ç”¨å¤‡ç”¨è¯†åˆ«æ–¹æ¡ˆ...`);

                // æ›´æ–°çŠ¶æ€
                if (type === 'wechat') {
                    document.getElementById('wechatStatus').textContent = 'å°è¯•å¤‡ç”¨è¯†åˆ«...';
                } else {
                    document.getElementById('alipayStatus').textContent = 'å°è¯•å¤‡ç”¨è¯†åˆ«...';
                }

                // å°è¯•APIè¯†åˆ«
                qrData = await decodeQRCodeWithAPI(canvas, type);
            }

            if (qrData) {
                if (type === 'wechat') {
                    wechatData = qrData;
                    document.getElementById('wechatStatus').textContent = 'âœ… è¯†åˆ«æˆåŠŸ';
                    document.querySelector('#wechatFile').parentElement.classList.add('active');
                } else {
                    alipayData = qrData;
                    document.getElementById('alipayStatus').textContent = 'âœ… è¯†åˆ«æˆåŠŸ';
                    document.querySelector('#alipayFile').parentElement.classList.add('active');
                }

                // æ£€æŸ¥æ˜¯å¦éƒ½ä¸Šä¼ å®Œæˆ
                if (wechatData && alipayData) {
                    console.log('âœ… ä¸¤ä¸ªäºŒç»´ç éƒ½å·²è¯†åˆ«');
                    document.getElementById('mergeBtn').disabled = false;
                    showMessage('âœ… äºŒç»´ç è¯†åˆ«æˆåŠŸ,å¯ä»¥å¼€å§‹åˆå¹¶äº†!');
                }
            } else {
                console.warn(`${type}: âŒ æ‰€æœ‰è¯†åˆ«æ–¹æ³•éƒ½å¤±è´¥äº†`);

                if (type === 'wechat') {
                    document.getElementById('wechatStatus').textContent = 'âŒ è¯†åˆ«å¤±è´¥,è¯·é‡æ–°ä¸Šä¼ ';
                    wechatData = null;
                } else {
                    document.getElementById('alipayStatus').textContent = 'âŒ è¯†åˆ«å¤±è´¥,è¯·é‡æ–°ä¸Šä¼ ';
                    alipayData = null;
                }
                showMessage('âŒ äºŒç»´ç è¯†åˆ«å¤±è´¥,è¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°å®Œæ•´');
            }
        }

        function generateQRCodeImage(text, size) {
            const qr = qrcode(0, 'H');
            qr.addData(text);
            qr.make();

            const cellSize = Math.floor(size / qr.getModuleCount());
            const actualSize = cellSize * qr.getModuleCount();

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = actualSize;
            tempCanvas.height = actualSize;
            const tempCtx = tempCanvas.getContext('2d');

            // ç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, actualSize, actualSize);

            // ç»˜åˆ¶äºŒç»´ç 
            for (let row = 0; row < qr.getModuleCount(); row++) {
                for (let col = 0; col < qr.getModuleCount(); col++) {
                    if (qr.isDark(row, col)) {
                        tempCtx.fillStyle = 'black';
                        tempCtx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                    }
                }
            }

            return tempCanvas;
        }

        function mergeQRCodes(isLiveUpdate = false) {
            if (!wechatData || !alipayData) {
                showMessage('âŒ è¯·å…ˆä¸Šä¼ å¹¶è¯†åˆ«ä¸¤ä¸ªäºŒç»´ç ');
                return;
            }

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // è·å–æ–‡å­—è®¾ç½®
            const bottomText = document.getElementById('bottomText').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const textColor = document.getElementById('textColor').value;
            const fontWeight = document.getElementById('fontWeight').value;

            // è·å–ä½ç½®è°ƒæ•´
            const qrPosX = parseInt(document.getElementById('qrPosX').value);
            const qrPosY = parseInt(document.getElementById('qrPosY').value);
            const bottomTextPosY = parseInt(document.getElementById('bottomTextPosY').value);

            // è®¡ç®—ç”»å¸ƒå°ºå¯¸
            const overallSize = parseInt(document.getElementById('overallSize').value);
            const topPadding = 20;
            const bottomPadding = bottomText ? fontSize + 40 : 20;

            let canvasWidth, canvasHeight, qrSize;

            // æ•´ä½“å¤§å°æ§åˆ¶çš„æ˜¯äºŒç»´ç çš„å¤§å°ï¼Œè¾¹æ¡†ä¿æŒåŸå§‹å°ºå¯¸
            qrSize = overallSize;

            if (frameImage) {
                // æœ‰è¾¹æ¡†æ—¶,ç”»å¸ƒä½¿ç”¨è¾¹æ¡†çš„åŸå§‹å°ºå¯¸
                canvasWidth = frameImage.width;
                canvasHeight = frameImage.height;
            } else {
                // æ²¡æœ‰è¾¹æ¡†æ—¶,ç”»å¸ƒæ ¹æ®äºŒç»´ç å¤§å°è®¡ç®—
                canvasWidth = qrSize;
                canvasHeight = qrSize + topPadding + bottomPadding;
            }

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            try {
                let qrStartY = topPadding;

                // å¦‚æœæœ‰è¾¹æ¡†å›¾ç‰‡,å…ˆç»˜åˆ¶è¾¹æ¡†ï¼ˆåŸå§‹å°ºå¯¸ï¼‰
                if (frameImage) {
                    ctx.drawImage(frameImage, 0, 0, frameImage.width, frameImage.height);
                    // å¦‚æœæœ‰è¾¹æ¡†,äºŒç»´ç åº”è¯¥ç»˜åˆ¶åœ¨ä¸­å¿ƒ
                    qrStartY = (canvasHeight - qrSize) / 2;
                }

                // ç”Ÿæˆå¾®ä¿¡äºŒç»´ç (å¤§)
                const wechatQRCanvas = generateQRCodeImage(wechatData, qrSize);

                // ç”Ÿæˆæ”¯ä»˜å®äºŒç»´ç (å°) - æ ¹æ®æ¯”ä¾‹è®¡ç®—
                const alipayRatio = parseInt(document.getElementById('alipayRatio').value) / 100;
                const alipaySize = qrSize * alipayRatio;
                const alipayQRCanvas = generateQRCodeImage(alipayData, alipaySize);

                // è®¡ç®—äºŒç»´ç çš„Xåæ ‡(å±…ä¸­) + ç”¨æˆ·è°ƒæ•´
                const qrStartX = (canvasWidth - qrSize) / 2 + qrPosX;
                const adjustedQrStartY = qrStartY + qrPosY;

                // ç»˜åˆ¶å¾®ä¿¡äºŒç»´ç 
                ctx.drawImage(wechatQRCanvas, qrStartX, adjustedQrStartY, qrSize, qrSize);

                // ç»˜åˆ¶æ”¯ä»˜å®äºŒç»´ç åˆ°å³ä¸‹è§’
                const marginRight = parseInt(document.getElementById('marginRight').value);
                const marginBottom = parseInt(document.getElementById('marginBottom').value);

                const x = qrStartX + qrSize - alipayQRCanvas.width - marginRight;
                const y = adjustedQrStartY + qrSize - alipayQRCanvas.height - marginBottom;

                // å…ˆç”»ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = 'white';
                ctx.fillRect(x - 5, y - 5, alipayQRCanvas.width + 10, alipayQRCanvas.height + 10);

                // å†ç”»æ”¯ä»˜å®äºŒç»´ç 
                ctx.drawImage(alipayQRCanvas, x, y);

                // ç»˜åˆ¶æ–‡å­—
                if (bottomText) {
                    ctx.font = `${fontWeight} ${fontSize}px "PingFang SC", "Microsoft YaHei", sans-serif`;
                    ctx.fillStyle = textColor;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // ç»˜åˆ¶åº•éƒ¨æ–‡å­— (åº”ç”¨ä½ç½®è°ƒæ•´)
                    const bottomTextY = canvasHeight - bottomPadding / 2 + bottomTextPosY;
                    ctx.fillText(bottomText, canvasWidth / 2, bottomTextY);
                }

                // æ˜¾ç¤ºç»“æœ(åªåœ¨é¦–æ¬¡ç”Ÿæˆæ—¶ä¿®æ”¹DOM,é¿å…æ»šåŠ¨è·³åŠ¨)
                if (!isLiveUpdate) {
                    document.getElementById('canvas').style.display = 'block';
                    document.getElementById('downloadBtn').style.display = 'block';
                    document.querySelector('#resultArea h3').textContent = 'âœ… åˆå¹¶æˆåŠŸ!';
                    document.querySelector('#resultArea p').style.display = 'none';
                    showMessage('âœ… äºŒç»´ç åˆå¹¶æˆåŠŸ!');
                }

                // æ¢å¤æ»šåŠ¨ä½ç½®(é˜²æ­¢å®æ—¶æ›´æ–°æ—¶è·³åŠ¨)
                if (isLiveUpdate) {
                    requestAnimationFrame(() => {
                        window.scrollTo(0, scrollTop);
                    });
                }

            } catch (error) {
                showMessage('âŒ ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }

        function downloadImage() {
            const canvas = document.getElementById('canvas');
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().getTime();
                a.download = `merged_qrcode_${timestamp}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('âœ… å›¾ç‰‡å·²ä¸‹è½½!');
            }, 'image/png');
        }
    </script>
</body>
</html>
